"use strict";var ct=Object.create;var v=Object.defineProperty,pt=Object.defineProperties,ut=Object.getOwnPropertyDescriptor,mt=Object.getOwnPropertyDescriptors,dt=Object.getOwnPropertyNames,W=Object.getOwnPropertySymbols,yt=Object.getPrototypeOf,L=Object.prototype.hasOwnProperty,ft=Object.prototype.propertyIsEnumerable;var I=(n,t,e)=>t in n?v(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,S=(n,t)=>{for(var e in t||={})L.call(t,e)&&I(n,e,t[e]);if(W)for(var e of W(t))ft.call(t,e)&&I(n,e,t[e]);return n},x=(n,t)=>pt(n,mt(t));var gt=(n,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of dt(t))!L.call(n,r)&&r!==e&&v(n,r,{get:()=>t[r],enumerable:!(i=ut(t,r))||i.enumerable});return n};var D=(n,t,e)=>(e=n!=null?ct(yt(n)):{},gt(t||!n||!n.__esModule?v(e,"default",{value:n,enumerable:!0}):e,n));var s=(n,t,e)=>new Promise((i,r)=>{var c=y=>{try{b(e.next(y))}catch(h){r(h)}},p=y=>{try{b(e.throw(y))}catch(h){r(h)}},b=y=>y.done?i(y.value):Promise.resolve(y.value).then(c,p);b((e=e.apply(n,t)).next())});var st=D(require("express")),at=D(require("cors")),lt=D(require("@trpc/server/adapters/express"));var M=D(require("express"));var m=require("fs");function q(n,t){for(let e of t.split(".")){if(n[e]===void 0)return;n=n[e]}return n}var H=(n,t,e)=>{let i=q(e,t.key),r=t.value.toLowerCase();if(i)switch(n){case"is":if(i===r)return e;break;case"not":if(i!==r)return e;break;case"contains":if(r.includes(i)||i.includes(r))return e;break;case"startsWith":if(i.startsWith(r))return e;break;case"doesntStartWith":if(!i.startsWith(r))return e;break;case"endsWith":if(i.endsWith(r))return e;break;case"doesntEndWith":if(!i.endsWith(r))return e;break;case"lt":if(Number(i)<Number(r))return e;break;case"gt":if(Number(i)>Number(r))return e;break;case"lte":if(Number(i)<=Number(r))return e;break;case"gte":if(Number(i)>=Number(r))return e;break;case"matches":if(i.match(r))return e;break;case"doesntMatch":if(!i.match(r))return e;break}},O=["is","not","contains","startsWith","endsWith","doesntStartWith","doesntEndWith","lt","gt","lte","gte","matches","doesntMatch"];var $=D(require("process"));var a=class{constructor(){}static createJson(t,e,i,r){let c=$.default.cwd()+`${t}/${e}.json`;if((0,m.existsSync)(c))return console.log("File already exists"),{data:null,message:`File ${i[r]} already exists`,status:"neutral"};try{return(0,m.writeFileSync)(c,JSON.stringify(i,null,2)),console.log("File Created"),{data:null,message:`File ${i[r]} created`,status:"ok"}}catch(p){return console.log("Can't create file: "+p),{data:null,message:"Something went wrong!",status:"error"}}}static getAllFromDir(t){return s(this,null,function*(){try{return(yield m.promises.readdir(t)).filter(r=>r.endsWith(".json")).map(r=>{let c=(0,m.readFileSync)(t+"/"+r);return JSON.parse(c.toString())})}catch(e){console.error("Something went wrong with reading: asdasd"+$.default.cwd(),e)}})}static getOneFromDir(t,e){return s(this,null,function*(){let i=`${t}/${e}.json`;console.log(i,"path"),(0,m.existsSync)(i)||console.log("File does not exists");try{let r=yield m.promises.readFile(i);return JSON.parse(r.toString())}catch(r){console.log(r)}})}static renameJson(t,e,i){return s(this,null,function*(){let r=`${t}/${e}.json`,c=`${t}/${i}.json`;if(!(0,m.existsSync)(r))return console.log("File does not exist"),{data:null,message:"File does not exist",status:"neutral"};try{return yield m.promises.rename(r,c),{data:null,message:"File renamed",status:"ok"}}catch(p){console.log(p)}})}static updateJson(t,e,i){return s(this,null,function*(){let r=`${t}/${e}.json`,c=yield this.getOneFromDir(t,e);if(!c)return{data:null,message:"File does not exist",status:"neutral"};let p=Object.assign(c,i);return console.log(p,"updatedJSON"),yield m.promises.writeFile(r,JSON.stringify(p,null,2)),{data:null,message:"File updated",status:"ok"}})}static getFromDirByKey(t,e,i,r="is"){return s(this,null,function*(){let c=`${t}/${e}`;if(!(0,m.existsSync)(c))return console.log("Collection does not exist"),null;try{let p=[],b=yield m.promises.readdir(c);for(let y of b){let h=JSON.parse((yield m.promises.readFile(`${c}/${y}`)).toString());H(r,i,h)&&p.push(h)}return p.length===1?p[0]:p}catch(p){console.log(p)}})}};var j=require("fs");function J(n){(0,j.existsSync)(n)||(0,j.mkdirSync)(n)}var f=class{constructor(){}static getAll(){return s(this,null,function*(){return yield a.getAllFromDir(this.filePath)})}static get(t){return s(this,null,function*(){return yield a.getOneFromDir(this.filePath,t)})}static create(t){return a.createJson(this.filePath,t.handle,x(S({},t),{templateData:{main:{title:{section:"main",display:"Title",handle:"title",required:!0,type:"text"}},sideBar:{slug:{display:"Slug",handle:"slug",required:!0,type:"text"}}}}),"title")}static update(t,e){return s(this,null,function*(){return yield a.updateJson(this.filePath,e,{templateData:t})})}};f.filePath="/dist/resources/templates";var d=class{constructor(){}static getAll(){return s(this,null,function*(){return yield a.getAllFromDir(this.filePath)})}static get(t){return s(this,null,function*(){return yield a.getOneFromDir(this.filePath,t)})}static create(t,e){return e?a.createJson(this.filePath+e,"handle"in t?t.handle:String(t.content.main.title),t,"title"):("handle"in t&&(J(this.filePath+t.handle),f.create({handle:t.handle,title:t.title})),a.createJson(this.filePath,"handle"in t?t.handle:String(t.content.main.title),t,"title"))}static createDirectory(t){return J(this.filePath+"/"+t)}static getAllEntries(t){return s(this,null,function*(){return yield a.getAllFromDir(this.filePath+t)})}static createCollection(t){let e=x(S({},t),{templates:[t.handle]});return this.create(e)}static createEntry(t,e){return this.create(t,e)}static getEntriesByKey(t,e,i,r="is"){return a.getFromDirByKey(this.filePath,t,{key:e,value:i},r)}static update(t,e,i){return s(this,null,function*(){if(i){let r=i?yield this.getEntriesByKey(e,"id",i):null,c=r?r.content.main.title:null;c&&c!==t.title&&(yield a.renameJson(this.filePath+e,c,t.title))}return yield a.updateJson(this.filePath,t.title?e+"/"+t.title:e,t)})}};d.filePath="/dist/content/collections"+"/";var P=class{constructor(t){this.res=t}notFound(){this.res.status(404).send("Not found"+"/dist/content/collections")}badRequest(t){this.res.status(400).send("Bad request - "+t)}invalidCondition(){this.res.status(400).send("Invalid condition!Valid conditions are: "+O.join(", "))}invalidQuery(){this.res.status(400).send("Invalid query")}};var V=(0,M.default)();V.get("/collections/:collectionHandle",(n,t)=>s(void 0,null,function*(){var h,z;let e=new P(t),[i]=[n.params.collectionHandle],r=Object.keys((h=n.query.filter)!=null?h:{});if(!r[0]){let K=yield d.getAllEntries(i);return K?t.send({collections:K}):e.notFound()}let[c,p]=r[0].split(":"),b=Object.values((z=n.query.filter)!=null?z:{});if(!O.includes(p))return e.invalidCondition();if(!i)return e.badRequest("No collection handle");let y=yield d.getEntriesByKey(i,c,b[0],p);if(!y)return e.notFound();t.send(y)}));var U=V;var Z=require("@trpc/server"),Q=Z.initTRPC.create({errorFormatter({shape:n}){return n}}),g=Q.router,l=Q.procedure;var u=require("zod");var o=require("zod"),G=o.z.union([o.z.string(),o.z.number(),o.z.boolean()]),Zt=o.z.object({title:o.z.string(),handle:o.z.string()}),Qt=o.z.object({templates:o.z.array(o.z.string()),numberOfEntries:o.z.number()}),F=o.z.lazy(()=>o.z.union([G,o.z.array(F),o.z.record(F)])),N=o.z.lazy(()=>o.z.union([G,o.z.array(N),o.z.record(N)])),Gt=o.z.object({id:o.z.string().uuid(),title:o.z.string(),apiUrl:o.z.string().url({message:"Invalid URL"}),content:F,template:o.z.string(),createdAt:o.z.date(),updatedAt:o.z.date(),published:o.z.boolean(),updatedBy:o.z.string()}),ht=o.z.object({name:o.z.string(),size:o.z.number(),type:o.z.string(),lastModified:o.z.number(),lastModifiedDate:o.z.string(),alt:o.z.string()}),B=o.z.object({file:ht,base64:o.z.string()}),X=o.z.object({title:o.z.string(),handle:o.z.string(),templateData:N.or(o.z.undefined())}),Y=o.z.object({title:o.z.string(),handle:o.z.string(),templateData:N});var _=require("uuid");var tt=g({getAll:l.query(()=>d.getAll()),getOne:l.input(u.z.object({handle:u.z.string()})).query(n=>{let{handle:t}=n.input;return d.get(t)}),getEntry:l.input(u.z.object({collectionHandle:u.z.string(),entryId:u.z.string()})).query(n=>{let{collectionHandle:t,entryId:e}=n.input;return d.getEntriesByKey(t,"id",e)}),getAllEntries:l.input(u.z.object({collectionHandle:u.z.string()})).query(n=>{let{collectionHandle:t}=n.input;return d.getAllEntries(t)}),create:l.input(u.z.object({title:u.z.string(),handle:u.z.string(),templates:u.z.array(u.z.string())})).mutation(n=>{let{input:t}=n;return d.createCollection(x(S({},t),{numberOfEntries:0}))}),createEntry:l.input(u.z.object({collectionHandle:u.z.string(),content:F})).mutation(n=>{let{input:t}=n;if(!t.content)return null;typeof t.content=="object"&&"main"in t.content&&console.log(t.content.main.Title);let e={id:(0,_.v4)(),title:t.content.main.Title,apiUrl:"",content:t.content,template:t.collectionHandle,createdAt:new Date,updatedAt:new Date,published:!1,updatedBy:"admin"};return d.createEntry(e,t.collectionHandle)}),updateEntry:l.input(u.z.object({collectionHandle:u.z.string(),entryId:u.z.string(),content:F})).mutation(n=>s(void 0,null,function*(){let{input:t}=n;if(!t.content)return null;let e={id:t.entryId,title:t.content.main.title,content:t.content,updatedAt:new Date,published:!1,updatedBy:"admin"};return yield d.update(e,t.collectionHandle,t.entryId)}))});var w=require("zod");var et=g({getAll:l.query(()=>s(void 0,null,function*(){return yield f.getAll()})),getOne:l.input(w.z.object({handle:w.z.string()})).query(n=>s(void 0,null,function*(){let{handle:t}=n.input;return yield f.get(t)})),create:l.input(X).mutation(n=>{let{input:t}=n;return f.create(t)}),edit:l.input(w.z.object({handle:w.z.string(),data:w.z.any()})).mutation(n=>s(void 0,null,function*(){let{input:t}=n;return yield f.update(t.data,t.handle)}))});var T=class{constructor(){}static getAll(){return s(this,null,function*(){return yield a.getAllFromDir(this.filePath)})}static get(t){return s(this,null,function*(){return yield a.getOneFromDir(this.filePath,t)})}static create(t){return s(this,null,function*(){return a.createJson(this.filePath,t.title,t,"handle")})}static getEntryByKey(t,e){return a.getFromDirByKey(this.filePath,t,{key:"handle",value:e})}static update(t,e){return s(this,null,function*(){return yield a.updateJson(this.filePath,t.title?e+"/"+t.title:e,t)})}};T.filePath="/dist/resources/components"+"/";var A=require("zod");var nt=g({getAll:l.query(()=>s(void 0,null,function*(){return yield T.getAll()})),getOne:l.input(A.z.object({handle:A.z.string()})).query(n=>s(void 0,null,function*(){let{handle:t}=n.input;return yield T.get(t)})),create:l.input(Y).mutation(n=>{let{input:t}=n;return T.create(t)}),update:l.input(A.z.object({handle:A.z.string(),templateData:A.z.any()})).mutation(({input:n})=>{let{templateData:t,handle:e}=n,i={handle:e,templateData:t};return T.update(i,e)})});var E=require("zod");var C=class{constructor(){}static getAll(){return s(this,null,function*(){return yield a.getAllFromDir(this.filePath)})}static get(t){return s(this,null,function*(){return yield a.getOneFromDir(this.filePath,t)})}static upload(t){return s(this,null,function*(){return a.createJson(this.filePath,t.file.name,t,"file")})}static update(t,e){return s(this,null,function*(){return a.updateJson(this.filePath,t,e)})}};C.filePath="/dist/resources/assets"+"/";var rt=g({getAll:l.query(()=>C.getAll()),getOne:l.input(E.z.object({handle:E.z.string()})).query(n=>{let{handle:t}=n.input;return C.get(t)}),upload:l.input(E.z.object({file:B})).mutation(n=>{let{file:t}=n.input;return C.upload(t)}),update:l.input(E.z.object({assetName:E.z.string(),asset:B})).mutation(n=>{let{assetName:t,asset:e}=n.input;return C.update(t,e)})});var it=g({collection:tt,template:et,assets:rt,component:nt});var R=(0,st.default)(),ot=4e3;R.use((0,at.default)());R.use("/api",U);R.use("/trpc",lt.createExpressMiddleware({router:it}));R.listen(ot,()=>{console.log(`App listening on port ${ot}`)});
